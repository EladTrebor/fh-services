name: Stryker

concurrency:
  group: "${{ github.workflow }}-${{ github.ref }}"
  cancel-in-progress: true

on:
  push:
    branches: ["main", "release-*", "FHB-729"]
  pull_request:
    paths:
      - '.github/workflows/stryker.yml'
      - '.github/workflows/stryker-template.yml'
      - 'src/**'

jobs:
  stryker:
    name: ${{ matrix.job_name }}
    strategy:
      fail-fast: false
      matrix:
        artifact:
          [
            idam-api,
            idam-core,
            notification-contracts,
            notification-api,
            notification-core,
            referral-api,
            referral-core,
            report-api,
            report-core,
            sd-api,
            sd-core,

            connect-dashboard-web,
            connect-dashboard-core,
            connect-web,
            connect-core,
            find-web,
            find-core,
            manage-web,
            manage-core,

            referral-shared,
            sd-shared,
            shared-kernel,
            web-components
          ]
        include:
          - project_directory: src/FamilyHubs.Idam.Api
            working_directory: service/idam-api
            job_name: "Stryker - Idam API - Api"
            artifact: idam-api
          - project_directory: src/FamilyHubs.Idam.Core
            working_directory: service/idam-api
            job_name: "Stryker - Idam API - Core"
            artifact: idam-core
          - project_directory: shared/FamilyHubs.Notification.Api.Contracts
            working_directory: service/notification-api
            job_name: "Stryker - Notification API - Api Contracts"
            artifact: notification-contracts
          - project_directory: src/FamilyHubs.Notification.Api
            working_directory: service/notification-api
            job_name: "Stryker - Notification API - Api"
            artifact: notification-api
          - project_directory: src/FamilyHubs.Notification.Core
            working_directory: service/notification-api
            job_name: "Stryker - Notification API - Core"
            artifact: notification-core
          - project_directory: src/FamilyHubs.Report.Api
            working_directory: service/report-api
            job_name: "Stryker - Report API - Api"
            artifact: report-api
          - project_directory: src/FamilyHubs.Report.Core
            working_directory: service/report-api
            job_name: "Stryker - Report API - Core"
            artifact: report-core
          - project_directory: src/FamilyHubs.Referral.Api
            working_directory: service/referral-api
            job_name: "Stryker - Referral API - Api"
            artifact: referral-api
          - project_directory: src/FamilyHubs.Referral.Core
            working_directory: service/referral-api
            job_name: "Stryker - Referral API - Core"
            artifact: referral-core
          - project_directory: src/FamilyHubs.ServiceDirectory.Api
            working_directory: service/service-directory-api
            job_name: "Stryker - Service Directory API - Api"
            runs_on_windows: true
            artifact: sd-api
          - project_directory: src/FamilyHubs.ServiceDirectory.Core
            working_directory: service/service-directory-api
            job_name: "Stryker - Service Directory API - Core"
            runs_on_windows: true
            artifact: sd-core

          - project_directory: src/FamilyHubs.RequestForSupport.Web
            working_directory: ui/connect-dashboard-ui
            job_name: "Stryker - Connect Dashboard UI - Web"
            artifact: connect-dashboard-web
          - project_directory: src/FamilyHubs.RequestForSupport.Core
            working_directory: ui/connect-dashboard-ui
            job_name: "Stryker - Connect Dashboard UI - Core"
            artifact: connect-dashboard-core
          - project_directory: src/FamilyHubs.Referral.Web
            working_directory: ui/connect-ui
            job_name: "Stryker - Connect UI - Web"
            artifact: connect-web
          - project_directory: src/FamilyHubs.Referral.Core
            working_directory: ui/connect-ui
            job_name: "Stryker - Connect UI - Core"
            artifact: connect-core
          - project_directory: src/FamilyHubs.ServiceDirectory.Web
            working_directory: ui/find-ui
            job_name: "Stryker - Find UI - Web"
            artifact: find-web
          - project_directory: src/FamilyHubs.ServiceDirectory.Core
            working_directory: ui/find-ui
            job_name: "Stryker - Find UI - Core"
            artifact: find-core
          - project_directory: src/FamilyHubs.ServiceDirectory.Admin.Web
            working_directory: ui/manage-ui
            job_name: "Stryker - Manage UI - Web"
            artifact: manage-web
          - project_directory: src/FamilyHubs.ServiceDirectory.Admin.Core
            working_directory: ui/manage-ui
            job_name: "Stryker - Manage UI - Core"
            artifact: manage-core

          - project_directory: src/FamilyHubs.ReferralService.Shared
            working_directory: shared/referral-shared
            job_name: "Stryker - Referral Shared"
            artifact: referral-shared
          - project_directory: src/FamilyHubs.ServiceDirectory.Shared
            working_directory: shared/service-directory-shared
            job_name: "Stryker - Service Directory Shared"
            artifact: sd-shared
          - project_directory: src/fh-shared-kernel.shared-kernel
            working_directory: shared/shared-kernel
            job_name: "Stryker - Shared Kernel"
            artifact: shared-kernel
          - project_directory: src/FamilyHubs.SharedKernel.Razor
            working_directory: shared/web-components
            job_name: "Stryker - Shared Kernel Razor"
            artifact: web-components
    uses: ./.github/workflows/stryker-template.yml
    with:
      working_directory: ${{ matrix.working_directory }}
      project_directory: ${{ matrix.project_directory }}
      runs_on: ${{ matrix.runs_on_windows && 'windows-2022' || 'ubuntu-22.04' }}
      artifact: ${{ matrix.artifact }}
  artifact:
    runs-on: ubuntu-latest
    if: always()
    needs: stryker
    steps:
    - name: "Merge artifacts"
      uses: actions/upload-artifact/merge@v4
      with:
        separate-directories: true
        delete-merged: true
        pattern: stryker-*
